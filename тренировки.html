import { useState, useEffect } from "react";

const exercises = ["Отжимания", "Приседания", "Пресс"];

const getTodayDate = () => new Date().toISOString().split("T")[0];

export default function Daily100Tracker() {
  const [progress, setProgress] = useState(() => {
    const saved = localStorage.getItem("dailyProgress");
    return saved ? JSON.parse(saved) : {};
  });

  const today = getTodayDate();

  useEffect(() => {
    localStorage.setItem("dailyProgress", JSON.stringify(progress));
  }, [progress]);

  const initDay = () => {
    if (!progress[today]) {
      setProgress({
        ...progress,
        [today]: {
          Отжимания: Array(10).fill(false),
          Приседания: Array(10).fill(false),
          Пресс: Array(10).fill(false),
        },
      });
    }
  };

  useEffect(initDay, [today]);

  const toggleCheck = (exercise, index) => {
    const dayProgress = { ...progress[today] };
    dayProgress[exercise][index] = !dayProgress[exercise][index];
    setProgress({ ...progress, [today]: dayProgress });
  };

  const getTotal = (exercise) =>
    Object.values(progress).reduce((acc, day) => acc + day[exercise].filter(Boolean).length * 10, 0);

  return (
    <div className="p-6 max-w-xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">Трекер 100 повторений в день</h1>
      <p className="mb-4 text-sm text-gray-600">{today}</p>

      {exercises.map((exercise) => (
        <div key={exercise} className="mb-6">
          <h2 className="text-xl font-semibold mb-2">
            {exercise} — Всего: {getTotal(exercise)}
          </h2>
          <div className="grid grid-cols-5 gap-2">
            {progress[today]?.[exercise]?.map((done, index) => (
              <button
                key={index}
                onClick={() => toggleCheck(exercise, index)}
                className={`w-12 h-12 rounded-full text-lg font-bold border-2 ${
                  done ? "bg-green-500 text-white" : "bg-white text-black"
                }`}
              >
                {(index + 1) * 10}
              </button>
            ))}
          </div>
        </div>
      ))}

      <CountdownTimer />
    </div>
  );
}

function CountdownTimer() {
  const [timeLeft, setTimeLeft] = useState(3600); // 1 час

  useEffect(() => {
    const timer = setInterval(() => {
      setTimeLeft((prev) => (prev > 0 ? prev - 1 : 0));
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  };

  return (
    <div className="mt-8 text-center">
      <p className="text-sm text-gray-500">Следующее напоминание через:</p>
      <div className="text-3xl font-mono">{formatTime(timeLeft)}</div>
    </div>
  );
}
